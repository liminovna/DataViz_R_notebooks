---
title: "R Notebook"
output: html_notebook
---

# HW5: Correspondence analysis

```         
Работа Ли-Мин Владиславы
```

```{r}
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("skimr")) install.packages("skimr")

library(tidyverse)
library(skimr)

infinitives <- read_tsv("https://raw.githubusercontent.com/olesar/2025dav4compling/refs/heads/main/data/PeriphrasticFutureMidRussian.txt", col_names = TRUE) %>%
  as.data.frame() %>%
    select(!ends_with("_Imp")) %>%
      select(!быти_Lform)

```

## Проверка датасета

Пользуясь столбцом INF, дайте имя каждому ряду таблицы сопряженности (с помощью функции row.names или column_to_rownames). Оставьте в таблице только целочисленные данные. Выведите первые 6 строк таблицы. Проверьте, что таблица не содержит missing data.

```{r}
```

```{r}
# превращаем столбец INF в индекс
infinitives <- column_to_rownames(infinitives, 'INF')

# проверяем, нет ли пропущенных данных
sum(is.na(infinitives))

top_n(infinitives, 6)
```

## Chisq test

Примените тест Хи-квадрат Пирсона к таблице сопряженности.

Постройте таблицу с ожидаемыми значениями для таблицы сопряженности.

Предложите анализ теста Хи-квадрат. Что можно сказать об ассоциации между конструкциями (они обозначены вспомогательными глаголами в той или иной временной форме) и инфинитивами? Какие проблемы вы видите в применении теста Хи-квадрат к этим данным?

```{r}
# применяем тест Хи-квадрат Пирсона
infinitives_chisq <- chisq.test(infinitives)
infinitives_chisq
```

**Статистическая интерпретация p-value**

P-value меньше 0.05, а значит, при 5%-ом уровне значимости мы имеем основания отвергнуть нулевую гипотезу о независимости употребления вспомогательных глаголов и инфинитивов.

**Содержательная интерпретация**

Выбор начинательного глагола зависит от следующего за ним инфинитива.

```{r}
# проверяем пропущенные значения
sum(is.na(infinitives))

# Таблица с ожидаемыми значениями
infinitives_chisq$expected
```

Команда `chisq.test(infinitives)` вызывает предупреждение `Chi-squared approximation may be incorrect`, поскольку некоторые ожидаемые значения меньше 5. Это связано с тем, что тест хи-квадрат следует непрерывному распределению, но на малых выборках статистики не распределены непрерывно.

## Baloon plot

С помощью функции `balloonplot` визуализируем данные в таблице сопряженности.

```{r}
if (!require("gplots")) install.packages("gplots")
library("gplots")

options(repr.plot.width=15, repr.plot.height=15)


infinitives |> as.matrix() |> as.table() |>
  gplots::balloonplot(main ="", xlab ="", ylab="",
              label = FALSE, show.margins = FALSE, text.size=0.5, colsrt=45, colmar=3, rowmar=3)
```

## Хи-квадрат на меньшей таблице

Оставьте меньшее количество строк и столбцов в таблице (вы можете убирать те или иные столбцы или объединять данные из нескольких столбцов или строк). Результирующая таблица должна быть размером не меньше 3 x 3 и корректна для проведения теста Хи-квадрат. Проведите снова тест Хи-квадрат и запишите ваши выводы.

Вычислите величину эффекта для теста с помощью V Крамера.

Визуализируйте таблицу с помощью мозаичного графика.

Запишите ваши выводы по ассоциации данных в меньшей таблице.

```{r}
# группируем столбцы и суммируем значения
infinitives_grouped <- infinitives %>%
  rownames_to_column(var = "INF") %>%
  pivot_longer(cols=-INF, names_to = ".value",
               names_pattern = "(.*?)_") %>%
  mutate(быти = replace_na(быти, 0)) %>%
  group_by(INF) %>%
  summarise(across(everything(), sum)) %>%
  column_to_rownames('INF')
infinitives_grouped

# берем строки, где минимальное значение > 5
infinitives_short <- infinitives_grouped[c("бити","говорити","дѣлати","жити"),c("быти","начати","почати","стати","учати","хотѣти")]
infinitives_short

infinitives_short_chisq <- chisq.test(infinitives_short)
infinitives_short_chisq

```

Уменьшился хи-квадрат и степень свободы, а p-value осталось прежним. Следовательно нулевую гипотезу о независимости вспомогательных глаголов и инфинитивов мы по-прежнему можем отвергнуть.

```{r}
if (!require("lsr")) install.packages("lsr")
library(lsr)

# Вычисление величины эффекта для теста с помощью V Крамера.
cramersV(infinitives_short)

if (!require("vcd")) install.packages("vcd")
library(vcd)

infinitives_short

# Мозаичный график
library('vcd')

vcd::mosaic(
  infinitives_short_chisq$observed,
  set_varnames = list(A = "Инфинитив", B = "Вспомогательный глагол"),
  shade = TRUE,
  gp_labels = gpar(fontsize = 6)
)
```

## Интерактивная тепловая карта

Вернемся к полной таблице сопряженности. Используйте функцию heatmaply для интерактивной визуализации ассоциации между строками и столбцами.

```{r}
if (!require("heatmaply")) install.packages("heatmaply")
library(heatmaply)
```

```{r}
heatmaply(infinitives)
```

## Анализ соответствий

В этом разделе мы предлагаем использовать пакеты factoextra и FactoMineR, но вы можете использовать и другие пакеты R. Постройте модель анализа соответствий и запишите ее в переменную ca.model. Выведите summary модели.

```{r}
if (!require("factoextra")) install.packages("factoextra")
library(factoextra)

if (!require("FactoMineR")) install.packages("FactoMineR")
library(FactoMineR)
```

```{r}
ca.model <- FactoMineR::CA(infinitives, ncp = 5, graph = TRUE)
ca.model
```

```{r}
print(ca.model)
```

## Screeplot

Визуализируйте screeplot.

Запишите ваши выводы, какую долю объясненной дисперсии представляют первые два измерения?

```{r}
factoextra::fviz_screeplot(ca.model, addlabels = TRUE, ylim = c(0, 50))
```

Первые два измерения представляют 47% объясненной дисперсии.

## Biplot

Постройте базовый биплот.

Постройте плот для данных в столбцах. Цвет должен отражать сontribution каждого конкретного столбца.

Здесь вы можете построить более продвинутый биплот с использованием цвета, прозрачности, repel.

```{r}
factoextra::fviz_ca_biplot(ca.model, col.col="contrib", col.row = "black", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE, alpha.col=1, alpha.row=0.3)

```

для лучшей читабельности, т.к. не получилось изменить прозрачность лэйблов:

```{r}

factoextra::fviz_ca_col(ca.model, col.col="contrib", col.row = "black", gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), repel = TRUE, alpha.col=1, alpha.row=0.3)

```

## Выводы

Предложите ваш анализ визуализаций, полученных методом Анализа соответствий.

```         
- вспомогательные глаголы `мочи` и `хотѣти` чаще употребляются с инфинитивами `сотворити`, `учинити`, `итти`, `дати`, `послати`
- вспомогательные глаголы `почати`, `начати`, `учати` и `стати` чаще употребляются с инфинитивами `говорити`, `воевати`, `пѣти`, `глаголати`, `жити`, `просити`, `бити`, `посылати`, `дѣлати`, `творити`
```

Полезные ссылки:

-   <https://statsandr.com/blog/chi-square-test-of-independence-in-r/>

-   <https://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/113-ca-correspondence-analysis-in-r-essentials/>
